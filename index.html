<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://code.jquery.com/jquery-2.1.4.js"></script>
    <script src="mixpanel-platform.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <style>
    #background {
      background-color: #fdfdfd;
      -webkit-border-radius: 5px;
      border-radius: 5px;
      border: 1px solid #bfcfda;
    }
    #axis {
      width: 55px;
    }
    #graph {
      padding-top: 55px;
      background-color: white;
      margin-left: 55px;
      border-left: 1px solid #d4e0e8;
      border-radius: 0 5px 5px 0;
      position: absolute;
    }
    #graph-overlay {
      position: absolute;
      margin-left: 55px;
    }
    .line {
      border-top: 1px dashed #d2dfe7;
      height: 55px;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    .funnel-step {
      margin: 0 50px;
      width: 60px;
      display: inline-block;
    }
    .converted {
      background-color: #65afe7;
    }
    .dropped {
      background-color: #e0e3ed;
    }
    </style>
    <div class="mixpanel-platform-section">
      <div id="dates"></div>
      <div id="report">
        <div id="background">
          <div id="axis"></div>
          <div id="graph">
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
          </div>
          <div id="graph-overlay">
            <div id="funnel"></div>
          </div>
        </div>
      </div>
    </div>
    <p></p>
    <script>
    // create funnel
    $('#dates').MPDatepicker();
    var funnelGraph = $('#funnel');
    var ratio = calculateGraphRatio();
    function addFunnelStep(eventName, converted, dropped, first) {
      var first = first || false;
      if (first) {
        ratio = calculateGraphRatio(converted);
      }
      var funnelStep = $('<div class="funnel-step"></div>').appendTo(funnelGraph);
      $('<div class="dropped"></div>').height(dropped*ratio).appendTo(funnelStep);
      $('<div class="converted"></div>').height(converted*ratio).appendTo(funnelStep);
    }
    
    function calculateGraphRatio(count) {
      var count = count || 1;
      var total = $('#graph').height();
      return total/count;
    }
    
    addFunnelStep('homepage new', 10, 0, true);
    addFunnelStep('Viewed report', 7, 3);
    addFunnelStep('Billing - First Payment', 5, 2);
    
    // custom query
    function runQuery() {
      var dateVal = $('#dates').val();
      var params = {
        'from_date': dateVal.from,
        'to_date': dateVal.to,
        'params': {}
      };
      var script = "var event_list = ['homepage new', 'Viewed report', 'Funnel query'];" +
        "function main() {" +
            "return Events({})" +
            ".filter(function(event){ return event['user_id']>500000})" +
            ".groupByUser(function(state, events) {" +
                "state = state || {"+
                    "event_path: [],"+
                    "funnel_step: 0"+
                "};"+
                "for (var i = 0; i < events.length; ++i) {"+
                    "if ((state.event_path.length === 0 && events[i]['name'] == event_list[0]) || state.event_path.length > 0) {"+
                        "state.event_path.push(events[i]['name']);"+
                        "state.funnel_step = 1;"+
                    "}"+
                "}"+
                "return state;"+
            "})"+
            ".filter(function(item) {"+
                "return item.value && item.value.funnel_step > 0;"+
            "})"+
            ".reduce(function(accumulators, items) {"+
                "var ret = [];"+
                "for (var j = 0; j < accumulators.length; j++) {"+
                    "ret = accumulators[j];"+
                "}"+
                "for (var i = 0; i < items.length; i++) {"+
                    "ret[i] = {funnel_step: items[i].value.funnel_step, dropoff_path: []};"+
                    "_.each(event_list.slice(1), function(event, j) {"+
                        "var eventIndex = items[i].value.event_path.indexOf(event);"+
                        "if (eventIndex > -1) {"+
                            "items[i].value.event_path.splice(0, eventIndex+1);"+
                            "ret[i].funnel_step ++;"+
                        "}"+
                        "else {"+
                            "items[i].value.event_path.splice(3, items[i].value.event_path.length);"+
                            "ret[i].dropoff_path = items[i].value.event_path;"+
                        "}"+
                    "});"+
                    "ret[i].funnel_step = event_list[ret[i].funnel_step-1]"+
                "}"+
                "return ret;"+
            "})"+
            ".reduce(function(accumulators, items) {"+
                "var result = {};"+
                "for (var i = 0; i < items.length; i++) {"+
                    "for (var j = 0; j < items[i].length; j++) {"+
                        "var eventName = items[i][j].funnel_step;"+
                        "var path = items[i][j].dropoff_path;"+
                        "result[eventName] = result[eventName] || {count: 0, all_paths: []};"+
                        "result[eventName].count ++;"+
                        "result[eventName].all_paths.push(path);"+
                    "}"+
                "}"+
                "return result;"+
            "})"+
            ".reduce(function(accumulators, items) {"+
                "var solution = {};"+
                "for (var i = 0; i < items.length; i++) {"+
                    "_.each(Object.keys(items[i]), function(eventName) {"+
                        "solution[eventName] = solution[eventName] || {count: items[i][eventName].count, flows: {}}"+
                        "for (var k in items[i][eventName].all_paths) {"+
                            "var s = solution[eventName].flows;"+
                            "for (var z in items[i][eventName].all_paths[k]){"+
                                "var e = items[i][eventName].all_paths[k][z]"+
                                "s[e] = s[e] || {'count':0, 'next':{}};"+
                                "s[e].count++;"+
                                "s = s[e].next;"+
                            "}"+
                        "}"+
                    "})"+
                "}"+
                "return solution;"+
            "});"+
        "}";
      
      MP.api.custom_query(script, {
        'from_date': '2015-11-01',
        'to_date': '2015-11-19',
        'params': params
      }).done(function(results) {
        $('p').text(JSON.stringify(results));
      });
    }
    </script>
  </body>
</html>
