<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://code.jquery.com/jquery-2.1.4.js"></script>
    <script src="mixpanel-platform.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <style>
    #report {
      margin: 20px 0 55px;
    }
    #background {
      background-color: #fdfdfd;
      -webkit-border-radius: 5px;
      border-radius: 5px;
      border: 1px solid #bfcfda;
      position: relative;
    }
    #axis {
      width: 55px;
    }
    #graph {
      padding-top: 55px;
      background-color: white;
      margin-left: 55px;
      border-left: 1px solid #d4e0e8;
      border-radius: 0 5px 5px 0;
      bottom: 0;
    }
    #graph-overlay {
      margin-left: 55px;
      position: absolute;
      bottom: -51px;
    }
    .line {
      border-top: 1px dashed #d2dfe7;
      height: 55px;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    .funnel-step {
      margin: 0 35px;
      width: 100px;
      display: inline-block;
    }
    .converted {
      width: 60px;
      margin: 0 auto;
      background-color: #65afe7;
    }
    .converted.first {
      border-radius: 3px 3px 0 0;
    }
    .dropped {
      width: 60px;
      margin: 0 auto;
      background-color: #e0e3ed;
      border-radius: 3px 3px 0 0;
      cursor: pointer;
    }
    .column-label {
      bottom: -45px;
      margin-top: 15px;
      text-align: center;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
      padding: 7px 14px;
      border: 1px solid #c4c9d8;
      border-radius: 50px;
      box-shadow: inset 0 1px #fff,0 1px 3px rgba(0,0,0,0.1);
      background-color: #f4f6f9;
      background-image: -webkit-linear-gradient(#f7f8fb,#f0f2f5);
      background-image: linear-gradient(#f7f8fb,#f0f2f5);
    }
    
    .flow {
      display: none;
    }
    .header {
      box-shadow: inset 0 1px #fff,0 1px 2px #fff;
      border-radius: 5px 5px 0 0;
      border: 1px solid #bfcfda;
      background-color: #edeff5;
      background-image: -webkit-linear-gradient(#f2f4f9,#e5e8ef);
      background-image: linear-gradient(#f2f4f9,#e5e8ef);
      padding: 0 18px;
    }
    #flow {
      background-color: white;
    }
    
    
    
    </style>
    <div class="mixpanel-platform-section">
      <div id="dates"></div>
      <div id="report">
        <div id="background">
          <div id="axis"></div>
          <div id="graph">
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
          </div>
          <div id="graph-overlay">
            <div id="funnel"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="mixpanel-platform-section flow">
      <div class="header"></div>
      <div id="flow"></div>
    </div>
    <p></p>
    <script>
    
    // create funnel
    $('#dates').MPDatepicker();
    var funnelGraph = $('#funnel');
    var ratio = calculateGraphRatio();
    
    function addFunnelStep(eventName, converted, dropped, first) {
      var first = first ? 'first' : '';
      if (first == 'first') {
        ratio = calculateGraphRatio(converted);
      }
      var funnelStep = $('<div class="funnel-step"></div>').appendTo(funnelGraph);
      $('<div class="dropped"></div>').height(dropped*ratio).appendTo(funnelStep);
      $('<div class="converted"></div>').height(converted*ratio).appendTo(funnelStep).addClass(first);
      $('<div class="column-label">' + eventName + '</div>').appendTo(funnelStep);
    }
    
    function calculateGraphRatio(count) {
      var count = count || 1;
      var total = $('#graph').height();
      return total/count;
    }
    
    // addFunnelStep('homepage new', 10, 0, true);
    // addFunnelStep('Viewed report', 7, 3);
    // addFunnelStep('Billing - First Payment', 5, 2);
    
    // dropoff flows
    $('#funnel').on('click', '.dropped', function() {
      var event = $(this).parents('.funnel-step').find('.column-label').text();
      showFlow(event);
    });
    
    function showFlow(event) {
      var flow = $('.flow').show();
      flow.find('.header').text(event + ' Alternative Paths');
      mapFlow(cqResult[event].flows);
    }
    
    function mapFlow(flows) {
      MP.api.MAX_SIMULTANEOUS_QUERIES = 30
      var datesSelector = $('#dateSelect').MPDatepicker();
      var rootEventSelect = $('#eventSelect').MPEventSelect();
      /* Global Event List */
      var rootEvent;
      var objs = {};
      var graphData = {}
      
      var width = 960;
      var height = 750;
      var cluster = d3.layout.cluster()
        .size([height, width - 160]);
      var diagonal = d3.svg.diagonal()
        .projection(function(d) { return [d.y, d.x]; });
  
      var svg = d3.select("#flow").append("svg")
        .attr("width", width)
        .attr("height", height)
        // .call(d3.behavior.zoom().on("zoom", function () {
        //         svg.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
        //       })
        //     )
        .append("g")
        .attr("transform", "translate(40,0)");
  
      function addNode(data){
  
        d3.selectAll(".text").remove();
        d3.selectAll(".node").remove();
        d3.selectAll(".link").remove();
  
        var nodes = cluster.nodes(data),
          links = cluster.links(nodes);
  
        nodes.forEach(function(d) { d.y = d.depth * 180; });
  
        var allLinks = svg.selectAll(".link").data(links);
        var link = allLinks.enter().append("path")
          .attr("class", "link")
          .style('stroke-width', function(d) {
            return ( d.target.root * .2 );
          });
  
        allLinks.transition().duration(1000).attr("d", diagonal);
  
        var allNodes = svg.selectAll(".node").data(nodes);
        var node = allNodes.enter().append("g")
          .attr("class", "node")
          .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
          // .on('mouseover', function(d){
          //     d3.select(this).style('opacity', 1.0)
          //     d3.select("text").style('opacity', 1.0);
          // })
          // .on('mouseout', function(d){
          //   d3.select(this).style('opacity', 0.6)
          // })
          .on('click', function(val){
              console.log (val)
              if (val.children) {
                val._children = val.children;
                val.children = null;
                addNode(graphData)
              } else if (val._children) {
                val.children = val._children;
                addNode(graphData);
              } else {
                val._children = true ;
                nodeQuery(objs, val);
              }
          });
  
        node.append('svg:title')
          .text(function(d) {
            var count = 'Count: ' + String(d.count) + '\n';
            return count + parent + root;
          });
        node.append("circle")
          .attr("r", 6.5);
  
        node.append("text")
          .attr("dx", function(d) { return d.children ? 0 : 8; })
          .attr("dy", function(d) { return d.children ? 18 : 3; })
          .text(function(d) { return d.name; })
          .attr("text-anchor", function(d){
            return ( d.children ? "middle" : undefined );
          });
      };
  
      /* Let the Funnel Queries Begin... */
  
      var nodeQuery = function(event_list, node){
        /* Dict with top counts for each event */
        var nodes = {};

        _.each(_.keys(event_list), function(key) {
          var event = event_list[key];
          var parent = node;
          var selector_str;
          var events = [];
          while (parent){
            events.push({'event': event});
            event = parent.name
            parent = parent.parent
          }
          events.push({'event': event});
          events.reverse();
          events.push(params);
        });

        /* Add Data to Graph Data */
        var total = _.values(nodes).reduce(function(a , b){return a + b;});
  
        _.each(_.keys(nodes), function(key){
          /*
            Build a node object with the conversion percentage and other meta data and add it to the children
            of the parent node
          */
          if (node.children) {
              node.children.push({
                'name':key,
                'count':nodes[key]
              });
          } else {
              node.children = [{
                'name':key,
                'count':nodes[key]
              }];
          }
        });
        addNode(graphData);
      }
        /* This Event Represents the Origin of the User Flow Diagram. */
        
        graphData = {
          'name': rootEvent,
        };

        /* Funnel Queries */
        $.when(topEvents).done(function(events){
            objs = events.values();
        });
        /* Find the Root Event Count */
        var rootEventCount = MP.api.segment(rootEvent,rootParams);
        
        $.when(rootEventCount).done(function(eventCount){
            graphData.count = eventCount.sum().values()[rootEvent];
            addNode(graphData);
        });

    }
    
    // custom query
    function runQuery() {
      var dateVal = $('#dates').val();
      var params = {
        'from_date': dateVal.from,
        'to_date': dateVal.to,
        'params': {}
      };
      var script = "var event_list = ['homepage new', 'Viewed report', 'Funnel query'];" +
        "function main() {" +
            "return Events({})" +
            ".filter(function(event){ return event['user_id']>500000})" +
            ".groupByUser(function(state, events) {" +
                "state = state || {"+
                    "event_path: [],"+
                    "funnel_step: 0"+
                "};"+
                "for (var i = 0; i < events.length; ++i) {"+
                    "if ((state.event_path.length === 0 && events[i]['name'] == event_list[0]) || state.event_path.length > 0) {"+
                        "state.event_path.push(events[i]['name']);"+
                        "state.funnel_step = 1;"+
                    "}"+
                "}"+
                "return state;"+
            "})"+
            ".filter(function(item) {"+
                "return item.value && item.value.funnel_step > 0;"+
            "})"+
            ".reduce(function(accumulators, items) {"+
                "var ret = [];"+
                "for (var j = 0; j < accumulators.length; j++) {"+
                    "ret = accumulators[j];"+
                "}"+
                "for (var i = 0; i < items.length; i++) {"+
                    "ret[i] = {funnel_step: items[i].value.funnel_step, dropoff_path: []};"+
                    "_.each(event_list.slice(1), function(event, j) {"+
                        "var eventIndex = items[i].value.event_path.indexOf(event);"+
                        "if (eventIndex > -1) {"+
                            "items[i].value.event_path.splice(0, eventIndex+1);"+
                            "ret[i].funnel_step ++;"+
                        "}"+
                        "else {"+
                            "items[i].value.event_path.splice(3, items[i].value.event_path.length);"+
                            "ret[i].dropoff_path = items[i].value.event_path;"+
                        "}"+
                    "});"+
                    "ret[i].funnel_step = event_list[ret[i].funnel_step-1]"+
                "}"+
                "return ret;"+
            "})"+
            ".reduce(function(accumulators, items) {"+
                "var result = {};"+
                "for (var i = 0; i < items.length; i++) {"+
                    "for (var j = 0; j < items[i].length; j++) {"+
                        "var eventName = items[i][j].funnel_step;"+
                        "var path = items[i][j].dropoff_path;"+
                        "result[eventName] = result[eventName] || {count: 0, all_paths: []};"+
                        "result[eventName].count ++;"+
                        "result[eventName].all_paths.push(path);"+
                    "}"+
                "}"+
                "return result;"+
            "})"+
            ".reduce(function(accumulators, items) {"+
                "var solution = {};"+
                "for (var i = 0; i < items.length; i++) {"+
                    "_.each(Object.keys(items[i]), function(eventName) {"+
                        "solution[eventName] = solution[eventName] || {count: items[i][eventName].count, flows: {}}"+
                        "for (var k in items[i][eventName].all_paths) {"+
                            "var s = solution[eventName].flows;"+
                            "for (var z in items[i][eventName].all_paths[k]){"+
                                "var e = items[i][eventName].all_paths[k][z]"+
                                "s[e] = s[e] || {'count':0, 'next':{}};"+
                                "s[e].count++;"+
                                "s = s[e].next;"+
                            "}"+
                        "}"+
                    "})"+
                "}"+
                "return solution;"+
            "});"+
        "}";
      
      MP.api.custom_query(script, {
        'from_date': '2015-11-01',
        'to_date': '2015-11-19',
        'params': params
      }).done(function(results) {
      });
var results = [
  {
    "homepage new": {
      "count": 11,
      "flows": {
        "homepage new": {
          "count": 11,
          "next": {
            "Viewed login page": {
              "count": 1,
              "next": {}
            },
            "homepage lessons learned hovered": {
              "count": 3,
              "next": {
                "Landing: Segmentation": {
                  "count": 1,
                  "next": {}
                },
                "jobs": {
                  "count": 1,
                  "next": {}
                },
                "homepage lessons learned hovered": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "homepage hero scrolled": {
              "count": 1,
              "next": {
                "homepage hero scrolled": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "Landing: Segmentation": {
              "count": 1,
              "next": {
                "homepage new": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "homepage new": {
              "count": 1,
              "next": {
                "View pricing page": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "View pricing page": {
              "count": 2,
              "next": {}
            }
          }
        }
      }
    },
    "Viewed report": {
      "count": 26,
      "flows": {
        "Viewed report": {
          "count": 10,
          "next": {
            "Retention query": {
              "count": 2,
              "next": {
                "Retention query": {
                  "count": 2,
                  "next": {}
                }
              }
            },
            "Viewed report": {
              "count": 4,
              "next": {
                "Tutorial Shown": {
                  "count": 1,
                  "next": {}
                },
                "Viewed report": {
                  "count": 1,
                  "next": {}
                },
                "Mixpanel Segmentation": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "Tutorial Shown": {
              "count": 2,
              "next": {
                "Tutorial Banner Shown": {
                  "count": 2,
                  "next": {}
                }
              }
            },
            "clicked logout link": {
              "count": 1,
              "next": {
                "Viewed login page": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "MPPlatform: intro modal viewed": {
              "count": 1,
              "next": {
                "Viewed report": {
                  "count": 1,
                  "next": {}
                }
              }
            }
          }
        },
        "Mixpanel Segmentation": {
          "count": 4,
          "next": {
            "Viewed report": {
              "count": 1,
              "next": {
                "Viewed report": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "Segmentation query": {
              "count": 1,
              "next": {
                "Viewed report": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "Tutorial Shown": {
              "count": 2,
              "next": {
                "Tutorial Banner Shown": {
                  "count": 2,
                  "next": {}
                }
              }
            }
          }
        },
        "Segmentation query": {
          "count": 2,
          "next": {
            "MPPlatform: custom report dropdown viewed": {
              "count": 1,
              "next": {
                "Segmentation query": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "Segmentation query": {
              "count": 1,
              "next": {
                "Segmentation query": {
                  "count": 1,
                  "next": {}
                }
              }
            }
          }
        },
        "Done": {
          "count": 1,
          "next": {
            "Viewed report": {
              "count": 1,
              "next": {
                "Done": {
                  "count": 1,
                  "next": {}
                }
              }
            }
          }
        },
        "View pricing page": {
          "count": 1,
          "next": {
            "Viewed report": {
              "count": 1,
              "next": {
                "clicked logout link": {
                  "count": 1,
                  "next": {}
                }
              }
            }
          }
        },
        "Tutorial Banner Shown": {
          "count": 1,
          "next": {
            "Tutorial Shown": {
              "count": 1,
              "next": {
                "Tutorial Banner Shown": {
                  "count": 1,
                  "next": {}
                }
              }
            }
          }
        },
        "Tutorial Shown": {
          "count": 6,
          "next": {
            "Tutorial Banner Shown": {
              "count": 6,
              "next": {
                "Viewed report": {
                  "count": 3,
                  "next": {}
                },
                "Segmentation query": {
                  "count": 2,
                  "next": {}
                },
                "Tutorial Shown": {
                  "count": 1,
                  "next": {}
                }
              }
            }
          }
        }
      }
    },
    "Funnel query": {
      "count": 11,
      "flows": {}
    }
  }
]
        cqResult = results[0];
        var events = Object.keys(cqResult);
        for (var i = 0; i < events.length; i++) {
          var first = i == 0 ? true : false;
          addFunnelStep(events[i], events[i][event].count, events[i][event].count-events[i-1][event].count, first);
        }
      // });
    }
    </script>
  </body>
</html>
