<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://code.jquery.com/jquery-2.1.4.js"></script>
    <script src="mixpanel-platform.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <style>
    #report {
      margin: 20px 0 55px;
    }
    #background {
      background-color: #fdfdfd;
      -webkit-border-radius: 5px;
      border-radius: 5px;
      border: 1px solid #bfcfda;
      position: relative;
    }
    #axis {
      width: 55px;
    }
    #graph {
      padding-top: 55px;
      background-color: white;
      margin-left: 55px;
      border-left: 1px solid #d4e0e8;
      border-radius: 0 5px 5px 0;
      bottom: 0;
    }
    #graph-overlay {
      margin-left: 55px;
      position: absolute;
      bottom: -51px;
    }
    .line {
      border-top: 1px dashed #d2dfe7;
      height: 55px;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    .funnel-step {
      margin: 0 35px;
      width: 100px;
      display: inline-block;
    }
    .converted {
      width: 60px;
      margin: 0 auto;
      background-color: #65afe7;
    }
    .converted.first {
      border-radius: 3px 3px 0 0;
    }
    .dropped {
      width: 60px;
      margin: 0 auto;
      background-color: #e0e3ed;
      border-radius: 3px 3px 0 0;
      cursor: pointer;
    }
    .column-label {
      bottom: -45px;
      margin-top: 15px;
      text-align: center;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
      padding: 7px 14px;
      border: 1px solid #c4c9d8;
      border-radius: 50px;
      box-shadow: inset 0 1px #fff,0 1px 3px rgba(0,0,0,0.1);
      background-color: #f4f6f9;
      background-image: -webkit-linear-gradient(#f7f8fb,#f0f2f5);
      background-image: linear-gradient(#f7f8fb,#f0f2f5);
    }
    
    .flow {
      display: none;
    }
    .header {
      box-shadow: inset 0 1px #fff,0 1px 2px #fff;
      border-radius: 5px 5px 0 0;
      border: 1px solid #bfcfda;
      background-color: #edeff5;
      background-image: -webkit-linear-gradient(#f2f4f9,#e5e8ef);
      background-image: linear-gradient(#f2f4f9,#e5e8ef);
      padding: 0 18px;
    }
    #flow {
      background-color: white;
    }
    
    
    
    </style>
    <div class="mixpanel-platform-section">
      <div id="dates"></div>
      <div id="report">
        <div id="background">
          <div id="axis"></div>
          <div id="graph">
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
          </div>
          <div id="graph-overlay">
            <div id="funnel"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="mixpanel-platform-section flow">
      <div class="header"></div>
      <div id="flow"></div>
    </div>
    <p></p>
    <script>
    
    // runQuery
    $(document).ready(function() {
      runQuery();
    })

    // create funnel
    $('#dates').MPDatepicker();
    var funnelGraph = $('#funnel');
    var ratio = calculateGraphRatio();
    
    function addFunnelStep(eventName, converted, dropped, first) {
      console.log('addingjQuery1710554227453423664_1448134645177?')
      var first = first ? 'first' : '';
      if (first == 'first') {
        ratio = calculateGraphRatio(converted);
      }
      var funnelStep = $('<div class="funnel-step"></div>').appendTo(funnelGraph);
      $('<div class="dropped"></div>').height(dropped*ratio).appendTo(funnelStep);
      $('<div class="converted"></div>').height(converted*ratio).appendTo(funnelStep).addClass(first);
      $('<div class="column-label">' + eventName + '</div>').appendTo(funnelStep);
    }
    
    function calculateGraphRatio(count) {
      var count = count || 1;
      var total = $('#graph').height();
      return total/count;
    }
    
    // addFunnelStep('homepage new', 10, 0, true);
    // addFunnelStep('Viewed report', 7, 3);
    // addFunnelStep('Billing - First Payment', 5, 2);
    
    // dropoff flows
    $('#funnel').on('click', '.dropped', function() {
      var event = $(this).parents('.funnel-step').find('.column-label').text();
      showFlow(event);
    });
    
    function showFlow(event) {
      var flow = $('.flow').show();
      flow.find('.header').text(event + ' Alternative Paths');
      mapFlow(cqResult[event].flows);
    }
    
    function mapFlow(flows) {
      var root = Object.keys(flows);
      flowObject = {
        'name': root,
        'count': flows[root].count,
        'children': []
      }
      _.each(_.keys(flows[root].next), function(event) {
        getChildren(event, flowObject);
      });
      console.log(flowObject);
    }
    
    function getChildren(parent, prevParent) {
      var eventObject = {'name': parent, 'count': parent.count, 'parent': prevParent, 'children': []};
      if ($.isEmptyObject(next) === false) {
        for (var event in next) {
          var newChildren = getChildren(event, parent);
          var child = {'name': event, 'count': event.count, 'parent': parent, 'children': newChildren};
          eventObject.children.push(child);
        }
      }
      prevParent.children.push(eventObject);
    }
    
    // custom query
    function runQuery() {
      var dateVal = $('#dates').val();
      var params = {
        'from_date': dateVal.from,
        'to_date': dateVal.to,
        'params': {}
      };
      var script = "var event_list = ['homepage new', 'Viewed report', 'Funnel query'];" +
        "function main() {" +
            "return Events({})" +
            ".filter(function(event){ return event['user_id']>500000})" +
            ".groupByUser(function(state, events) {" +
                "state = state || {"+
                    "event_path: [],"+
                    "funnel_step: 0"+
                "};"+
                "for (var i = 0; i < events.length; ++i) {"+
                    "if ((state.event_path.length === 0 && events[i]['name'] == event_list[0]) || state.event_path.length > 0) {"+
                        "state.event_path.push(events[i]['name']);"+
                        "state.funnel_step = 1;"+
                    "}"+
                "}"+
                "return state;"+
            "})"+
            ".filter(function(item) {"+
                "return item.value && item.value.funnel_step > 0;"+
            "})"+
            ".reduce(function(accumulators, items) {"+
                "var ret = [];"+
                "for (var j = 0; j < accumulators.length; j++) {"+
                    "ret = accumulators[j];"+
                "}"+
                "for (var i = 0; i < items.length; i++) {"+
                    "ret[i] = {funnel_step: items[i].value.funnel_step, dropoff_path: []};"+
                    "_.each(event_list.slice(1), function(event, j) {"+
                        "var eventIndex = items[i].value.event_path.indexOf(event);"+
                        "if (eventIndex > -1) {"+
                            "items[i].value.event_path.splice(0, eventIndex+1);"+
                            "ret[i].funnel_step ++;"+
                        "}"+
                        "else {"+
                            "items[i].value.event_path.splice(3, items[i].value.event_path.length);"+
                            "ret[i].dropoff_path = items[i].value.event_path;"+
                        "}"+
                    "});"+
                    "ret[i].funnel_step = event_list[ret[i].funnel_step-1]"+
                "}"+
                "return ret;"+
            "})"+
            ".reduce(function(accumulators, items) {"+
                "var result = {};"+
                "for (var i = 0; i < items.length; i++) {"+
                    "for (var j = 0; j < items[i].length; j++) {"+
                        "var eventName = items[i][j].funnel_step;"+
                        "var path = items[i][j].dropoff_path;"+
                        "result[eventName] = result[eventName] || {count: 0, all_paths: []};"+
                        "result[eventName].count ++;"+
                        "result[eventName].all_paths.push(path);"+
                    "}"+
                "}"+
                "return result;"+
            "})"+
            ".reduce(function(accumulators, items) {"+
                "var solution = {};"+
                "for (var i = 0; i < items.length; i++) {"+
                    "_.each(Object.keys(items[i]), function(eventName) {"+
                        "solution[eventName] = solution[eventName] || {count: items[i][eventName].count, flows: {}}"+
                        "for (var k in items[i][eventName].all_paths) {"+
                            "var s = solution[eventName].flows;"+
                            "for (var z in items[i][eventName].all_paths[k]){"+
                                "var e = items[i][eventName].all_paths[k][z]"+
                                "s[e] = s[e] || {'count':0, 'next':{}};"+
                                "s[e].count++;"+
                                "s = s[e].next;"+
                            "}"+
                        "}"+
                    "})"+
                "}"+
                "return solution;"+
            "});"+
        "}";
      
      // MP.api.custom_query(script, {
      //   'from_date': '2015-11-01',
      //   'to_date': '2015-11-19',
      //   'params': params
      // }).done(function(results) {
      // });
      
      

var results = [
  {
    "homepage new": {
      "count": 11,
      "flows": {
        "homepage new": {
          "count": 11,
          "next": {
            "Viewed login page": {
              "count": 1,
              "next": {}
            },
            "homepage lessons learned hovered": {
              "count": 3,
              "next": {
                "Landing: Segmentation": {
                  "count": 1,
                  "next": {}
                },
                "jobs": {
                  "count": 1,
                  "next": {}
                },
                "homepage lessons learned hovered": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "homepage hero scrolled": {
              "count": 1,
              "next": {
                "homepage hero scrolled": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "Landing: Segmentation": {
              "count": 1,
              "next": {
                "homepage new": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "homepage new": {
              "count": 1,
              "next": {
                "View pricing page": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "View pricing page": {
              "count": 2,
              "next": {}
            }
          }
        }
      }
    },
    "Viewed report": {
      "count": 26,
      "flows": {
        "Viewed report": {
          "count": 10,
          "next": {
            "Retention query": {
              "count": 2,
              "next": {
                "Retention query": {
                  "count": 2,
                  "next": {}
                }
              }
            },
            "Viewed report": {
              "count": 4,
              "next": {
                "Tutorial Shown": {
                  "count": 1,
                  "next": {}
                },
                "Viewed report": {
                  "count": 1,
                  "next": {}
                },
                "Mixpanel Segmentation": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "Tutorial Shown": {
              "count": 2,
              "next": {
                "Tutorial Banner Shown": {
                  "count": 2,
                  "next": {}
                }
              }
            },
            "clicked logout link": {
              "count": 1,
              "next": {
                "Viewed login page": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "MPPlatform: intro modal viewed": {
              "count": 1,
              "next": {
                "Viewed report": {
                  "count": 1,
                  "next": {}
                }
              }
            }
          }
        },
        "Mixpanel Segmentation": {
          "count": 4,
          "next": {
            "Viewed report": {
              "count": 1,
              "next": {
                "Viewed report": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "Segmentation query": {
              "count": 1,
              "next": {
                "Viewed report": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "Tutorial Shown": {
              "count": 2,
              "next": {
                "Tutorial Banner Shown": {
                  "count": 2,
                  "next": {}
                }
              }
            }
          }
        },
        "Segmentation query": {
          "count": 2,
          "next": {
            "MPPlatform: custom report dropdown viewed": {
              "count": 1,
              "next": {
                "Segmentation query": {
                  "count": 1,
                  "next": {}
                }
              }
            },
            "Segmentation query": {
              "count": 1,
              "next": {
                "Segmentation query": {
                  "count": 1,
                  "next": {}
                }
              }
            }
          }
        },
        "Done": {
          "count": 1,
          "next": {
            "Viewed report": {
              "count": 1,
              "next": {
                "Done": {
                  "count": 1,
                  "next": {}
                }
              }
            }
          }
        },
        "View pricing page": {
          "count": 1,
          "next": {
            "Viewed report": {
              "count": 1,
              "next": {
                "clicked logout link": {
                  "count": 1,
                  "next": {}
                }
              }
            }
          }
        },
        "Tutorial Banner Shown": {
          "count": 1,
          "next": {
            "Tutorial Shown": {
              "count": 1,
              "next": {
                "Tutorial Banner Shown": {
                  "count": 1,
                  "next": {}
                }
              }
            }
          }
        },
        "Tutorial Shown": {
          "count": 6,
          "next": {
            "Tutorial Banner Shown": {
              "count": 6,
              "next": {
                "Viewed report": {
                  "count": 3,
                  "next": {}
                },
                "Segmentation query": {
                  "count": 2,
                  "next": {}
                },
                "Tutorial Shown": {
                  "count": 1,
                  "next": {}
                }
              }
            }
          }
        }
      }
    },
    "Funnel query": {
      "count": 11,
      "flows": {}
    }
  }
]
        cqResult = results[0];
        var events = Object.keys(cqResult);
        for (var i = 0; i < events.length; i++) {
          var first = i == 0 ? true : false;
          if (first) {
            addFunnelStep(events[i], cqResult[events[i]].count, 0, first);
          } else {
            addFunnelStep(events[i], cqResult[events[i]].count, cqResult[events[i]].count-cqResult[events[i-1]].count, first);
          }
        }
      // });
    }
    </script>
  </body>
</html>
